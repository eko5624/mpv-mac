
name: build-tools

on:
  #schedule:
  #  - cron: '10 0 * * MON'
    
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - "macos-13"
          - "macos-14"
        include:
          - os: "macos-13"
            arch: "x86_64"
          - os: "macos-14"
            arch: "aarch64"
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Loading tools cache
      uses: actions/cache/restore@main
      with:
        path: ${{ github.workspace }}/workspace
        key: tools-${{ matrix.arch }}-${{ github.run_id }}
        restore-keys: tools-
    - name: Switch to Xcode 15.2
      run: |
        sudo xcode-select --reset
        sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer   
    - name: Remove stray upstream python binary symlinks under /usr/local
      run: |
        find /usr/local/bin -lname '*/Library/Frameworks/Python.framework/*' -delete -print
        brew unlink python
    - name: Build tools
      env:
        ARCHS: ${{ matrix.arch }} 
      run: |
        chmod +x ./build-tools.sh
        ./build-tools.sh
    - name: Get current timestamp
      run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_ENV 
    - name: Zip tools 
      continue-on-error: true
      run: |
        zip -r -y tools-${{ matrix.arch }}-${{ env.date }}.zip workspace/*
        cp tools-${{ matrix.arch }}-${{ env.date }}.zip tools-${{ matrix.arch }}-latest.zip
    - name: Delete
      uses: mknejp/delete-release-assets@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: toolchain
        assets: tools-${{ matrix.arch }}-latest.zip
        fail-if-no-assets: false
        fail-if-no-release: false
    - name: Upload tools
      continue-on-error: true
      uses: softprops/action-gh-release@master
      with:
        tag_name: toolchain
        name: toolchain
        files: tools*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Saving tools cache
      uses: actions/cache/save@main
      if: always()
      with:
        path: ${{ github.workspace }}/workspace
        key: tools-${{ matrix.arch }}-${{ github.run_id }}

