name: libiconv
on:
  #schedule:
  #  - cron: '10 0 * * MON'
    
  workflow_dispatch:
    inputs:   
      os:
        description: "Support cross-compile for arm64/x86_64 arch"
        required: false
        default: "macos-15"
        type: choice
        options:
        - macos-13
        - macos-15
      arch:
        description: "Build target"
        required: false
        default: "x86_64"
        type: choice
        options:
        - x86_64
        - arm64
        
jobs:
  molten-vk:
    runs-on: ${{ inputs.os }}
    env:
      ARCHS: ${{ inputs.arch }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:   
    - name: Checkout
      uses: actions/checkout@main
    - name: Setting tools arch
      id: tools-arch
      run: echo "t_arch=$(uname -m)" >> $GITHUB_ENV
    - name: Setting xcode version
      run: |
        if [ ${{ inputs.os }} == 'macos-13' ]; then
          echo "xcode=Xcode_15.2" >> $GITHUB_ENV
        elif [ ${{ inputs.os }} == 'macos-15' ]; then  
          echo "xcode=Xcode_16.4" >> $GITHUB_ENV
        fi 
    - name: Loading tools-${{ env.t_arch }} cache
      uses: actions/cache@main
      with:
        path: ${{ github.workspace }}/tools
        key: tools-${{ env.t_arch }}
    - name: Switch Xcode version
      run: |
        sudo xcode-select --reset
        sudo xcode-select -s /Applications/${xcode}.app/Contents/Developer  
    - name: Build
      run: |
        chmod +x ./scripts/molten-vk.sh
        ./scripts/molten-vk.sh
    - name: Delete
      uses: mknejp/delete-release-assets@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: dev-${{ inputs.arch }}
        assets: molten-vk*.xz
        fail-if-no-assets: false
        fail-if-no-release: false
    - name: Upload
      continue-on-error: true
      uses: softprops/action-gh-release@v2
      with:
        tag_name: dev-${{ inputs.arch }}
        name: dev-${{ inputs.arch }}
        files: molten-vk.tar.xz
        